# =============================================================================
# GIK Release Workflow
# =============================================================================
#
# This workflow builds and publishes GIK artifacts when a version tag is pushed.
#
# Trigger: Push of tags matching "v*" (e.g., v0.1.0, v1.0.0-rc.1)
#
# Jobs:
#   1. build-unix:    Builds Linux and macOS artifacts using matrix strategy
#   2. build-windows: Builds Windows artifact
#   3. publish-release: Downloads all artifacts and creates GitHub Release
#
# Artifacts produced:
#   - gik-linux-x86_64.tar.gz
#   - gik-macos-x86_64.tar.gz
#   - gik-macos-aarch64.tar.gz
#   - gik-windows-x86_64.zip
#
# =============================================================================

name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ===========================================================================
  # Build Unix (Linux & macOS)
  # ===========================================================================
  build-unix:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x86_64
            artifact: gik-linux-x86_64.tar.gz
          - os: macos-15-large  # Intel macOS (x86_64)
            target: macos-x86_64
            artifact: gik-macos-x86_64.tar.gz
          - os: macos-latest  # ARM64 macOS
            target: macos-aarch64
            artifact: gik-macos-aarch64.tar.gz
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Pull LFS files
        run: git lfs pull
      
      - name: Install protoc (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version
      
      - name: Install protoc (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install protobuf
          protoc --version
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-
            ${{ runner.os }}-cargo-
      
      - name: Build package
        run: |
          chmod +x ./scripts/gik-build-packages.sh
          ./scripts/gik-build-packages.sh
        env:
          TARGET: ${{ matrix.target }}
          GIK_VERSION: ${{ github.ref_name }}
      
      - name: Verify artifact exists
        run: |
          if [ ! -f "dist/${{ matrix.artifact }}" ]; then
            echo "ERROR: Expected artifact not found: dist/${{ matrix.artifact }}"
            ls -la dist/
            exit 1
          fi
          echo "Artifact size: $(ls -lh dist/${{ matrix.artifact }} | awk '{print $5}')"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: dist/${{ matrix.artifact }}
          if-no-files-found: error
          retention-days: 7

  # ===========================================================================
  # Build Windows
  # ===========================================================================
  build-windows:
    name: Build windows-x86_64
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Pull LFS files
        run: git lfs pull
      
      - name: Install protoc (Windows)
        run: |
          choco install protoc -y
          protoc --version
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-windows-x86_64-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-windows-x86_64-
            ${{ runner.os }}-cargo-
      
      - name: Build package
        run: .\scripts\gik-build-packages.ps1 -Target "windows-x86_64" -Version "${{ github.ref_name }}"
      
      - name: Verify artifact exists
        run: |
          if (-not (Test-Path "dist\gik-windows-x86_64.zip")) {
            Write-Error "Expected artifact not found: dist\gik-windows-x86_64.zip"
            Get-ChildItem dist\
            exit 1
          }
          $size = (Get-Item "dist\gik-windows-x86_64.zip").Length / 1MB
          Write-Host "Artifact size: $([math]::Round($size, 2)) MB"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64
          path: dist/gik-windows-x86_64.zip
          if-no-files-found: error
          retention-days: 7

  # ===========================================================================
  # Publish GitHub Release
  # ===========================================================================
  publish-release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [build-unix, build-windows]
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f -exec ls -lh {} \;
      
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # Copy all artifacts to release-assets directory
          cp artifacts/linux-x86_64/gik-linux-x86_64.tar.gz release-assets/
          cp artifacts/macos-x86_64/gik-macos-x86_64.tar.gz release-assets/
          cp artifacts/macos-aarch64/gik-macos-aarch64.tar.gz release-assets/
          cp artifacts/windows-x86_64/gik-windows-x86_64.zip release-assets/
          
          echo "Release assets prepared:"
          ls -lh release-assets/
      
      - name: Generate checksums
        run: |
          cd release-assets
          sha256sum * > SHA256SUMS.txt
          echo "Checksums:"
          cat SHA256SUMS.txt
      
      - name: Determine if prerelease
        id: prerelease
        run: |
          if [[ "${{ github.ref_name }}" == *"-"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "This is a prerelease: ${{ github.ref_name }}"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "This is a stable release: ${{ github.ref_name }}"
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: GIK ${{ github.ref_name }}
          draft: false
          prerelease: ${{ steps.prerelease.outputs.is_prerelease }}
          generate_release_notes: true
          files: |
            release-assets/gik-linux-x86_64.tar.gz
            release-assets/gik-macos-x86_64.tar.gz
            release-assets/gik-macos-aarch64.tar.gz
            release-assets/gik-windows-x86_64.zip
            release-assets/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
